<%- include('partials/header') -%>
<body>
    <div class="container mt-3">
        <div class="row">
            <div
                class="col-md-5 center-block"
                style="float: none; margin: auto"
            >
                <div style="margin-top: 10px" class="card text-center">
                    <div
                        style="font-size: 1.5rem; font-weight: bold"
                        class="card-header"
                    >
                        LOGIN
                    </div>
                    <div style="margin-top: 20px">
                        <iconify-icon
                            icon="logos:metamask-icon"
                            width="200"
                            style="margin: auto"
                        ></iconify-icon>
                    </div>
                    <div class="card-body">
                        <button
                            id="loginWithMetamask"
                            class="btn btn-primary btn-lg btn-block mt-2"
                        >
                            login with metamask
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    var account;
    var require_signature = "<%= require_signature  %>";
    var contract_address = "<%= contract_address  %>";
    const emptyAddress =
        "0x0000000000000000000000000000000000000000000000000000000000000000";

    //listener
    async function buildListener() {
        window.ethereum.on("accountsChanged", function (accounts) {
            account = accounts[0];
        });
        $("#loginWithMetamask").on("click", async function (e) {
            $.getJSON("../../contracts/IdentityManager.json", function (data) {
                // This code will be executed when the request succeeds
                let contractInstance = new web3.eth.Contract(
                    data.abi,
                    contract_address
                );

                contractInstance.methods
                    .getId()
                    .call({ from: account })
                    .then((result) => {
                        if (result === emptyAddress || !result) {
                            return Promise.reject(
                                "This account has not been bound yet!"
                            );
                        } else {
                            // Sign the identity and then send to server
                            return Promise.resolve(result);
                        }
                    })
                    .then((result) => {
                        web3.eth.personal
                            .sign(require_signature, account)
                            .then((res) => {
                                $.ajax({
                                    url: "/appChain/MinistryOfHealthandWelfare/loginWithMetamask",
                                    data: {
                                        identity: result, // DID
                                        signature: res, // signature
                                        account: account, // account
                                    },
                                    type: "post",
                                    success: function (res) {
                                        console.log("success");
                                        // console.log(res);
                                        //- window.location.replace("/profile");
                                        if (res.url)
                                            window.location.href = res.url;
                                    },
                                    error: function (err) {
                                        console.log("error");
                                        alert("only organization can login");
                                    },
                                });
                            });
                    })
                    .catch((err) => {
                        alert(err);
                    });
            }).fail(function (jqXHR, textStatus, errorThrown) {
                // This code will be executed if the request fails
                console.error(textStatus, errorThrown);
            });
        });
        // $("#loginWithMetamask").on("click", async function (e) {
        //     let result = await web3.eth.personal.sign(
        //         require_signature,
        //         account
        //     );
        //     //console.log("account = " + account);
        //     $.ajax({
        //         url: "/appChain/MinistryofHealthandWelfare/loginWithMetamask",
        //         data: {
        //             signature: result, // signature
        //             account: account, // account
        //         },
        //         type: "post",
        //         success: function (result) {
        //             if (result.msg) {
        //                 console.log(result.msg);
        //             } else if (result.url) {
        //                 window.location.href = result.url;
        //             }
        //         },
        //         error: function (err) {
        //             console.log(err);
        //         },
        //     });
        // });
    }

    async function main() {
        let accounts = await web3.eth.getAccounts();
        account = accounts[0];
        buildListener();
    }
    main();
</script>

<%- include('partials/footer') -%>
